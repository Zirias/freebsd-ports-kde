#!/bin/sh

# $FreeBSD$

PREFIX=%%PREFIX%%
BINDIR=${PREFIX}/bin
QTCHOOSER=${BINDIR}/qtchooser
VERSIONS=%%QT_SUPPORTED%%

if [ ! -d ${BINDIR} ] ; then
	echo "Binary directory '${BINDIR}' missing." >&2
	return 1
fi

if [ ! -x ${QTCHOOSER} ] ; then
	echo "Qtchooser binary '${QTCHOOSER}' missing." >&2
	return 2
fi

remove_links() {
	echo "Removing qtchooser links"
	for file in $(find -L ${BINDIR} -maxdepth 1 -samefile ${QTCHOOSER}) ; do
		if [ ! -L ${file} ] ; then
			continue
		fi
		local found=0
		for version in ${VERSIONS} ; do
			version_bin_dir=${PREFIX}/lib/qt${version}/bin
			target=${version_bin_dir}/$(basename ${file})
			if [ -x ${target} ] ; then
				found=1
				continue
			fi
		done
		if [ ${found} -eq 0 ] ; then
			echo "    ${file}"
			rm ${file}
		fi
	done
	echo "done"
}

create_links() {
	echo "Creating qtchooser links"
	for version in ${VERSIONS} ; do
		version_bin_dir=${PREFIX}/lib/qt${version}/bin
		if [ -d ${version_bin_dir} ] ; then
			for file in $(find ${version_bin_dir} -type f -maxdepth 1) ; do
				target=${BINDIR}/$(basename ${file})
				if [ ! -L ${target} -a ! -f ${target} ] ; then
					echo "    ${target}"
					ln -s ${QTCHOOSER} ${target}
				fi
			done
		fi
	done
	echo "done"
}

remove_links
create_links
